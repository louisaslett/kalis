<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Load haplotypes into optimised package cache — CacheHaplotypes • kalis</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/PT_Serif-0.4.9/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet"><link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Load haplotypes into optimised package cache — CacheHaplotypes"><meta name="description" content="Load haplotypes from hard drive or an R matrix into an optimised kalis package memory cache (overwrites any previous load)."><meta property="og:description" content="Load haplotypes from hard drive or an R matrix into an optimised kalis package memory cache (overwrites any previous load)."><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kalis</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Decoding_a_Single_Variant.html">Decoding a Single Variant</a></li>
    <li><a class="dropdown-item" href="../articles/Iterating_Over_Loci.html">Iterating Over Loci</a></li>
    <li><a class="dropdown-item" href="../articles/lct_example.html">Reproducing kalis Paper LCT Example</a></li>
    <li><a class="dropdown-item" href="../articles/Reading_Haplotype_Data.html">Reading Haplotype Data</a></li>
  </ul></li>
<li class="nav-item"><a class="external-link nav-link" href="https://doi.org/10.1186/s12859-024-05688-8">BMC Bioinformatics Paper</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/louisaslett/kalis/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Load haplotypes into optimised package cache</h1>
      <small class="dont-index">Source: <a href="https://github.com/louisaslett/kalis/blob/master/R/CacheHaplotypes.R" class="external-link"><code>R/CacheHaplotypes.R</code></a></small>
      <div class="d-none name"><code>CacheHaplotypes.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Load haplotypes from hard drive or an R matrix into an optimised kalis package memory cache (overwrites any previous load).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">CacheHaplotypes</span><span class="op">(</span></span>
<span>  <span class="va">haps</span>,</span>
<span>  loci.idx <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  hap.idx <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  warn.singletons <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-haps">haps<a class="anchor" aria-label="anchor" href="#arg-haps"></a></dt>
<dd><p>can be the name of a file from which the haplotypes are to be read, or can be an R matrix containing only 0/1s.
See Details section for supported file types.</p></dd>


<dt id="arg-loci-idx">loci.idx<a class="anchor" aria-label="anchor" href="#arg-loci-idx"></a></dt>
<dd><p>an optional vector of indices specifying the variants to load into the cache, indexed from 1.</p></dd>


<dt id="arg-hap-idx">hap.idx<a class="anchor" aria-label="anchor" href="#arg-hap-idx"></a></dt>
<dd><p>an optional vector of indices specifying the haplotypes to load into the cache, indexed from 1.</p></dd>


<dt id="arg-warn-singletons">warn.singletons<a class="anchor" aria-label="anchor" href="#arg-warn-singletons"></a></dt>
<dd><p>a logical, if <code>FALSE</code>, suppress warning that singletons (variants where there is only one 1 or only one 0) are present in the loaded <code>haps</code>.</p></dd>


<dt id="arg-format">format<a class="anchor" aria-label="anchor" href="#arg-format"></a></dt>
<dd><p>the file format that <code>haps</code> is stored in, or <code>"auto"</code> to detect the format based on the file extension.
Recognised options are <code>"hapgz"</code> (format used by IMPUTE2 and SHAPEIT) or <code>"hdf5"</code> (custom).
See Details section for more information, and for easy conversion from VCF/BCF and other formats see the Examples section.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>format specific options for reading in <code>haps</code>.
Supported optional arguments for each format are:</p><ol><li><p>For <code>"hapgz"</code></p><ul><li><p><code>legendgz.file</code> a string for faster loading: a <code>.legend.gz</code> file can be supplied and will be used to more efficiently determine the number of variants in the <code>.hap.gz</code> file</p></li>
<li><p><code>L</code> an integer for faster loading: the number of variants in the <code>.hap.gz</code> file can be directly provided</p></li>
<li><p><code>N</code> an integer for faster loading: the number of haplotypes in the <code>.hap.gz</code> file can be directly provided</p></li>
</ul></li>
<li><p>For <code>"hdf5"</code></p><ul><li><p><code>transpose</code> a logical, if <code>TRUE</code>, switch the interpretation of rows and columns in <code>haps</code>: hence switching the number of haplotypes and the number of variants (the HDF5 specification does not prescribe row/column interpretation, only defining the slowest changing dimension as 'first').
Defaults to <code>FALSE</code>.</p></li>
<li><p><code>haps.path</code> a string giving the path to a 2-dimensional object in the HDF5 file specifying the haplotype matrix.
Defaults to <code>/haps</code></p></li>
<li><p><code>hdf5.pkg</code> a string giving the HDF5 R package to use to load the file from disk.
The packages <code>rhdf5</code> (BioConductor) and <code>hdf5r</code> (CRAN) are both supported.
Default is to use <code>hdf5r</code> if both packages are available, with fallback to <code>rhdf5</code>.
This should never need to be specified unless you have both packages but want to force the use of the <code>rhdf5</code> package.</p></li>
</ul></li>
<li><p>R matrix</p><ul><li><p><code>transpose</code> a logical, if <code>TRUE</code>, switch the interpretation of rows and columns in <code>haps</code>: hence switching the number of haplotypes and the number of variants.
Defaults to <code>FALSE</code>, meaning variants are taken to be in rows with haplotypes in columns (ie a num variants x num haplotypes matrix)</p></li>
</ul></li>
</ol></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A vector giving the dimensions of the cached haplotype data is invisibly returned (num variants, num haplotypes).
It is highly recommended that you run <code><a href="CacheSummary.html">CacheSummary()</a></code> after <code>CacheHaplotypes</code>, especially if you are uncertain about the interpretation of rows and columns in <code>haps</code>.
If <code><a href="CacheSummary.html">CacheSummary()</a></code> shows that the number of haplotypes and variants are reversed, try calling <code>CacheHaplotypes</code> again with the extra argument <code>transpose = TRUE</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>To achieve higher performance, kalis internally represents haplotypes in an efficient raw binary format in memory.
This function will load haplotypes from a file or from a binary R matrix and convert this into kalis' internal format ready for use by the other functions in this package.
Note that only one set of haplotypes can be cached at a time and calling this function twice overwrites cache of haplotypes created by the first function call.</p>
<p>Including singletons (variants where there is only one 1 or only one 0) in the loaded haplotypes can lead to numerical instability and columns of <code>NaN</code>s in the resulting forward and backward tables when <code>mu</code> (see <code><a href="Parameters.html">Parameters()</a></code>) is small.
Thus, kalis throws a warning when loaded haplotypes contain singletons.</p>
<p>At present, hap.gz and hdf5 are supported natively, see the Examples section below showing for how to convert from a VCF/BCF to hap.gz with one <code>bcftools</code> command.</p>
<p><strong>hap.gz format</strong></p>
<p>This is the HAP/LEGEND/SAMPLE format used by IMPUTE2 and SHAPEIT.
Only the <code>.hap.gz</code> file is required for loading with <code>CacheHaplotypes</code>, though the <code>.legend.gz</code> file can speed up reading the haplotypes.
See <a href="http://samtools.github.io/bcftools/bcftools.html#convert" class="external-link">http://samtools.github.io/bcftools/bcftools.html#convert</a> for more details on this format.</p>
<p><strong>R matrix</strong></p>
<p>If supplying an R matrix, it must consist of only 0's or 1's.
The haplotypes should be stored in columns, with variants in rows.
That is, the dimensions should be:</p>
<p>(num rows)x(num cols) = (num variants)x(num haplotypes).</p>
<p>It is fine to delete this matrix from R after calling <code>CacheHaplotypes()</code>.</p>
<p><strong>HDF5 format</strong></p>
<p>For HDF5 files, kalis expects a 2-dimensional object named <code>haps</code> at the root level of the HDF5 file.
Haplotypes should be stored in the slowest changing dimension as defined in the HDF5 specification (note that different languages treat this as rows or columns).
If the haplotypes are stored in the other dimension then simply set the argument <code>transpose = TRUE</code>.
If the user is unsure of the convention of the language they used to create the HDF5 file, then the simplest approach is to simply load the data specifying only the HDF5 file name and then confirm that number of haplotypes and their length have not been exchanged in the diagnostic output which kalis prints.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Aslett, L.J.M. and Christ, R.R. (2024) "kalis: a modern implementation of the Li &amp; Stephens model for local ancestry inference in R", <em>BMC Bioinformatics</em>, <strong>25</strong>(1). Available at: <a href="https://doi.org/10.1186/s12859-024-05688-8" class="external-link">doi:10.1186/s12859-024-05688-8</a>
.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="CacheSummary.html">CacheSummary()</a></code> for a list detailing the current cache status;
<code><a href="QueryCache.html">QueryCache()</a></code> to copy the haplotypes in the <code>kalis</code> cache into an R matrix;
<code><a href="ClearHaplotypeCache.html">ClearHaplotypeCache()</a></code> to remove the haplotypes from the cache and free the memory;
<code><a href="CacheSummary.html">N()</a></code> for the number of haplotypes cached;
<code><a href="CacheSummary.html">L()</a></code> for the number of variants cached.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># If starting from a VCF/BCF first use bcftools to convert to</span></span></span>
<span class="r-in"><span><span class="co"># HAP/SAMPLE/LEGEND format (bcftools can take in several starting formats)</span></span></span>
<span class="r-in"><span><span class="co"># See http://samtools.github.io/bcftools/bcftools.html#convert</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"bcftools convert -h my.vcf.gz"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="st">"my.hap.gz"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="CacheSummary.html">CacheSummary</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If starting directly from a hap.gz file on disk (HAP/LEGEND/SAMPLE format)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="st">"my.hap.gz"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span><span class="co"># For example, to load the mini example built into the package:</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"small_example/small.hap.gz"</span>, package <span class="op">=</span> <span class="st">"kalis"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>haplotypes already cached ... overwriting existing cache.</span>
<span class="r-in"><span><span class="fu"><a href="CacheSummary.html">CacheSummary</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Cache currently loaded with 300 haplotypes, each with 400 variants. </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Memory consumed: 16 kB. </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If starting from an HDF5 file on disk</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="st">"my.h5"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span><span class="co"># For example, to load the mini example built into the package:</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"small_example/small.h5"</span>, package <span class="op">=</span> <span class="st">"kalis"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>haplotypes already cached ... overwriting existing cache.</span>
<span class="r-in"><span><span class="fu"><a href="CacheSummary.html">CacheSummary</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Cache currently loaded with 300 haplotypes, each with 400 variants. </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Memory consumed: 16 kB. </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If CacheSummary() indicates that the numbers of haplotypes and variants are</span></span></span>
<span class="r-in"><span><span class="co"># the wrong way around, reload with argument transpose set to TRUE</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="st">"myhaps.h5"</span>, transpose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="CacheSummary.html">CacheSummary</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Alternatively, if you have an exotic file format that can be loaded in to R</span></span></span>
<span class="r-in"><span><span class="co"># by other means, then a binary matrix can be supplied.  This example</span></span></span>
<span class="r-in"><span><span class="co"># randomly simulates a binary matrix to illustrate.</span></span></span>
<span class="r-in"><span><span class="va">n.haps</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></span>
<span class="r-in"><span><span class="va">n.vars</span> <span class="op">&lt;-</span> <span class="fl">200</span></span></span>
<span class="r-in"><span><span class="va">haps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n.haps</span><span class="op">*</span><span class="va">n.vars</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>               nrow <span class="op">=</span> <span class="va">n.vars</span>, ncol <span class="op">=</span> <span class="va">n.haps</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="va">haps</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>haplotypes already cached ... overwriting existing cache.</span>
<span class="r-in"><span><span class="co"># For example, to load the mini example built into the package:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"SmallHaps"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">CacheHaplotypes</span><span class="op">(</span><span class="va">SmallHaps</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>haplotypes already cached ... overwriting existing cache.</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louis Aslett, Ryan Christ.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

